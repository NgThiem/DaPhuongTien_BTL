<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Image Retrieval</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding: 20px; }
        .results img, .query img {
            width: 200px; height: 200px; object-fit: cover;
            margin: 10px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.3);
            cursor: pointer;
        }
        .query { margin-bottom: 20px; }
        .modal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5);}
        .modal-content { background:white; margin:10% auto; padding:20px; width:600px; text-align:center; border-radius:8px; }
        .close { float:right; font-size:28px; cursor:pointer; }
        .modal img { width:250px; height:250px; object-fit:cover; margin:10px; }
    </style>
</head>
<body>
<div class="container">
    <h1 class="mb-4">TÌM KIẾM ẢNH TƯƠNG TỰ (CNN + SIFT)</h1>

    <form id="uploadForm" method="POST" enctype="multipart/form-data">
        <div class="mb-3">
            <label for="fileInput" class="form-label">Chọn ảnh:</label>
            <input type="file" class="form-control" id="fileInput" name="file" required>
        </div>
        <div class="mb-3">
            <label for="topKInput" class="form-label">Số lượng ảnh:</label>
            <input type="number" class="form-control" id="topKInput" name="top_k" value="5" min="1" max="30">
        </div>
        <button type="submit" class="btn btn-primary">Tìm kiếm</button>
    </form>

    <div class="query mt-4">
        <h3>Ảnh truy vấn:</h3>
        <div id="queryContainer"></div>
    </div>

    <h3>Kết quả:</h3>
    <div class="results d-flex flex-wrap" id="resultsContainer"></div>
</div>

<div id="simModal" class="modal">
    <div class="modal-content">
        <span class="close">&times;</span>
        <h3>Độ tương đồng: <span id="simPercent"></span>%</h3>
        <div>
            <img id="modalQuery" src="">
            <img id="modalResult" src="">
        </div>
    </div>
</div>

<script>
const form = document.getElementById('uploadForm');
const resultsContainer = document.getElementById('resultsContainer');
const queryContainer = document.getElementById('queryContainer');
const simModal = document.getElementById('simModal');
const modalQuery = document.getElementById('modalQuery');
const modalResult = document.getElementById('modalResult');
const simPercent = document.getElementById('simPercent');

form.addEventListener('submit', async (e) => {
    e.preventDefault();  // ngăn form gửi GET

    resultsContainer.innerHTML = '';  // xóa Top-K cũ
    queryContainer.innerHTML = '';     // xóa query cũ nếu muốn thay ảnh mới

    const formData = new FormData(form);
    const file = formData.get('file');

    // Gửi form lên server
    const response = await fetch('/upload', { method: 'POST', body: formData });
    const data = await response.json();

    // Hiển thị ảnh query
    const queryUrl = data.query;
    const imgQuery = document.createElement('img');
    imgQuery.src = queryUrl;
    queryContainer.appendChild(imgQuery);

    // Hiển thị Top-K
    data.results.forEach(res => {
        const img = document.createElement('img');
        img.src = res.url;
        img.dataset.rel = res.rel_path;
        resultsContainer.appendChild(img);

        // Click ảnh → modal
        img.addEventListener('click', async () => {
            const resp = await fetch('/similarity', {
                method: 'POST',
                headers: {'Content-Type':'application/json'},
                body: JSON.stringify({query_path: queryUrl, result_rel: res.rel_path})
            });
            const simData = await resp.json();
            simPercent.textContent = simData.similarity.toFixed(2);
            modalQuery.src = queryUrl;
            modalResult.src = res.url;
            simModal.style.display = 'block';
        });
    });
});

// Đóng modal
simModal.querySelector('.close').addEventListener('click', () => simModal.style.display = 'none');
window.addEventListener('click', (e) => { if(e.target === simModal) simModal.style.display = 'none'; });
</script>
</body>
</html>
